<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Keyboard Ninjas{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/markdown/markdown.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
       
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        gray: {
                           50: '#f9fafb', 100: '#f3f4f6', 200: '#e5e7eb', 300: '#d1d5db',
                           400: '#9ca3af', 500: '#6b7280', 600: '#4b5563', 700: '#374151',
                           800: '#1f2937', 900: '#111827', 950: '#030712'
                        },
                        primary: {
                            '50': '#eff6ff', '100': '#dbeafe', '200': '#bfdbfe', '300': '#93c5fd',
                            '400': '#60a5fa', '500': '#3b82f6', '600': '#2563eb', '700': '#1d4ed8',
                            '800': '#1e40af', '900': '#1e3a8a', '950': '#172554'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        input:-webkit-autofill, input:-webkit-autofill:hover, input:-webkit-autofill:focus, input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #1f2937 inset !important;
            -webkit-text-fill-color: #e5e7eb !important;
        }
        
        .CodeMirror {
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            font-size: 14px;
        }
        .CodeMirror-gutters { background: #111827 !important; }
        .cm-s-material-darker.CodeMirror { background-color: #111827; }

        .editor-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-height: 200px;
        }
        .editor-container .CodeMirror {
            flex-grow: 1;
            height: auto;
        }

        .modal-container {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 300ms ease-in-out;
        }
        .modal-container.is-open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-container .modal-content {
            background-color: #1f2937;
            border-radius: 0.75rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid #374151;
            transform: scale(0.95);
            transition: transform 300ms ease-in-out;
            width: 100%;
            max-width: 90vw;
        }
        .modal-container.is-open .modal-content {
            transform: scale(1);
        }

        #chat-widget-container {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #chat-widget-container.is-open {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .chat-message .prose {
            font-size: 0.95rem;
            max-width: none;
        }
        .chat-message .prose p {
            margin-top: 0;
            margin-bottom: 0.5rem;
        }
        .chat-message .prose pre {
            background-color: #030712;
            color: #d1d5db;
            padding: 0.8rem;
            border-radius: 0.5rem;
            white-space: pre-wrap;
        }
        .chat-message .prose code {
            font-size: 0.85rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300 font-sans">
    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 bg-gray-800 p-4 flex-shrink-0 flex flex-col border-r border-gray-700">
            <a href="/" class="flex items-center gap-3 mb-8 px-2">
                <img src="/static/img/ninja.png" alt="Keyboard Ninjas Logo" class="h-16 w-auto">
                <h1 class="text-xl font-bold text-white">Keyboard Ninjas</h1>
            </a>
            <nav class="flex flex-col gap-2">
                <a href="/training" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-300 rounded-lg hover:bg-gray-700 transition-colors duration-200 {% if page == 'training' %}bg-primary-600 text-white shadow-md{% endif %}">
                    <i class="fas fa-book-open w-6 text-center text-lg"></i><span>Courses</span>
                </a>
                <h3 class="text-xs font-semibold text-gray-500 uppercase mt-6 mb-2 px-4">Admin Panel</h3>
                <a href="/admin/training" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-300 rounded-lg hover:bg-gray-700 transition-colors duration-200 {% if page == 'admin_training' %}bg-primary-600 text-white shadow-md{% endif %}">
                    <i class="fas fa-edit w-6 text-center text-lg"></i><span>Manage Courses</span>
                </a>
                <a href="/admin/qa" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-300 rounded-lg hover:bg-gray-700 transition-colors duration-200 {% if page == 'admin_qa' %}bg-primary-600 text-white shadow-md{% endif %}">
                    <i class="fas fa-question-circle w-6 text-center text-lg"></i><span>Manage Q&A</span>
                </a>
                <a href="/admin/documents" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-300 rounded-lg hover:bg-gray-700 transition-colors duration-200 {% if page == 'admin_documents' %}bg-primary-600 text-white shadow-md{% endif %}">
                    <i class="fas fa-file-alt w-6 text-center text-lg"></i><span>Manage Documents</span>
                </a>
            </nav>
            <div class="mt-auto"></div>
        </aside>

        <main class="flex-1 p-6 md:p-8 lg:p-10 overflow-y-auto">
            {% block content %}{% endblock %}
        </main>
    </div>

    <button id="chat-bubble" class="fixed bottom-8 right-8 bg-primary-600 text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg hover:bg-primary-500 transition-transform transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-primary-500 z-50">
        <i class="fas fa-comment-dots text-2xl"></i>
    </button>
    
    <div id="chat-widget-container" class="fixed bottom-28 right-8 w-full max-w-md bg-gray-800 rounded-xl shadow-2xl z-50 flex flex-col border border-gray-700" style="height: 60vh;">
        <div class="flex items-center justify-between p-3 bg-gray-900/50 rounded-t-xl border-b border-gray-700 flex-shrink-0">
            <h3 class="font-bold text-white">AI Tutor</h3>
            <button id="close-chat-widget" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>
        <div class="flex-grow p-4 overflow-y-auto space-y-4" id="chat-widget-messages">
        </div>
        <div class="p-3 border-t border-gray-700 flex-shrink-0">
            <div class="flex items-center bg-gray-700 rounded-lg">
                <input type="text" id="chat-widget-input" class="flex-grow bg-transparent border-none text-white placeholder-gray-400 focus:ring-0 px-4 py-2" placeholder="Ask a question...">
                <button id="chat-widget-send" class="p-2 text-primary-400 hover:text-primary-300">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
    
    {% block modals %}{% endblock %}

    <script>
        function setupModal(triggerId, modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return null;
            modal.classList.add('modal-container');
            const trigger = document.getElementById(triggerId);
            const closeButtons = modal.querySelectorAll('.modal-close');

            const openModal = () => modal.classList.add('is-open');
            const closeModal = () => modal.classList.remove('is-open');

            if (trigger) {
                trigger.addEventListener('click', openModal);
            }
            
            closeButtons.forEach(btn => btn.addEventListener('click', closeModal));
            modal.addEventListener('click', (e) => { 
                if (e.target.classList.contains('modal-container')) { 
                    closeModal(); 
                } 
            });
            return { open: openModal, close: closeModal };
        }

        document.addEventListener('DOMContentLoaded', () => {
            const chatBubble = document.getElementById('chat-bubble');
            const chatWidget = document.getElementById('chat-widget-container');
            const closeChatWidget = document.getElementById('close-chat-widget');
            const chatInput = document.getElementById('chat-widget-input');
            const chatSend = document.getElementById('chat-widget-send');
            const messagesContainer = document.getElementById('chat-widget-messages');
            let chatSessionId = null;

            async function startChatSession() {
                try {
                    const response = await fetch('/api/chat/sessions', { method: 'POST' });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    chatSessionId = data.session_id;
                    addChatMessage("Hello! How can I help you with your coding today?", 'assistant');
                } catch (error) {
                    console.error("Failed to create chat session:", error);
                    addChatMessage("Error: Could not connect to the tutor.", 'assistant');
                }
            }
            
            function addChatMessage(message, role, meta = null) {
                const msgWrapper = document.createElement('div');
                msgWrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} mb-2`;

                const msgDiv = document.createElement('div');
                msgDiv.innerHTML = marked.parse(message);
                msgDiv.className = `prose p-3 rounded-lg max-w-xs text-sm shadow ${role === 'user' ? 'bg-primary-600 text-white prose-invert' : 'bg-gray-700 text-gray-200 prose-invert'}`;
                
                msgWrapper.appendChild(msgDiv);
                messagesContainer.appendChild(msgWrapper);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                return msgDiv;
            }

            async function handleSendMessage() {
                const message = chatInput.value.trim();
                if (!message || !chatSessionId) return;

                addChatMessage(message, 'user');
                chatInput.value = '';
                chatSend.disabled = true;

                const assistantMessageDiv = addChatMessage('<span class="italic text-gray-400">Typing...</span>', 'assistant');
                assistantMessageDiv.innerHTML = "";
                
                let fullAssistantMessage = ""; 
                
                let pageContext = null;
                if (typeof getPageContext === 'function') {
                    pageContext = getPageContext();
                }

                const payload = {
                    message: message,
                    context: pageContext
                };

                try {
                    const response = await fetch(`/api/chat/sessions/${chatSessionId}/send`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.body) throw new Error("No response body");
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n\n');
                        buffer = lines.pop();

                        for (const line of lines) {
                            if (line.startsWith('data:')) {
                                try {
                                    const jsonStr = line.substring(5).trim();
                                    const data = JSON.parse(jsonStr);
                                    if (data.content) {
                                        fullAssistantMessage += data.content;
                                        assistantMessageDiv.innerHTML = marked.parse(fullAssistantMessage);
                                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                    }
                                } catch (e) {
                                    // Ignore JSON parsing errors
                                }
                            }
                        }
                    }
                    
                    assistantMessageDiv.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                } catch (error) {
                    console.error("Chat send failed:", error);
                    assistantMessageDiv.textContent = "Sorry, I couldn't get a response. Please try again.";
                } finally {
                    chatSend.disabled = false;
                    chatInput.focus();
                }
            }

            chatBubble.addEventListener('click', () => {
                chatWidget.classList.toggle('is-open');
                if (chatWidget.classList.contains('is-open')) {
                    chatInput.focus();
                    if (!chatSessionId) {
                        startChatSession();
                    }
                }
            });
            closeChatWidget.addEventListener('click', () => chatWidget.classList.remove('is-open'));
            chatSend.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html></html>