{% extends "base.html" %}
{% block title %}{{ lesson.title }}{% endblock %}
{% block content %}
<div class="h-full flex flex-col">
    <div class="mb-6 flex-shrink-0">
        <a href="/training/course/{{ lesson.section.course_id }}" class="text-sm text-primary-400 hover:underline"><i class="fas fa-arrow-left mr-2"></i>Back to Course</a>
        <h1 class="text-3xl font-bold text-white mt-3">{{ lesson.title }}</h1>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-grow min-h-0">
        <div class="bg-gray-800/50 rounded-xl p-6 flex flex-col min-h-0">
            <h2 class="text-xl font-semibold text-white mb-4 flex-shrink-0">Instructions</h2>
            <div id="lesson-instructions" class="prose prose-invert prose-p:text-gray-300 prose-headings:text-white max-w-none flex-grow overflow-y-auto">
                {{ lesson.content | safe }}
            </div>
        </div>

        <div class="bg-gray-800/50 rounded-xl flex flex-col min-h-0">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center flex-shrink-0">
                 <h2 class="text-xl font-semibold text-white">Code Lab</h2>
                 <button id="runCodeBtn" class="btn btn-success">
                    <i class="fas fa-play mr-2"></i> Run Code
                </button>
            </div>
            <div class="flex-grow flex flex-col p-4 gap-4 min-h-0">
                 <div class="flex-1 flex flex-col min-h-0">
                     <textarea id="codeEditor">{{ lesson.starting_code or '' }}</textarea>
                </div>

                <div class="h-40 flex flex-col flex-shrink-0">
                     <label class="font-mono text-sm text-gray-400 mb-2">> Output:</label>
                     <pre id="codeOutput" class="h-full overflow-y-auto bg-gray-900/80 rounded-lg p-3 font-mono text-sm text-gray-300 whitespace-pre-wrap"></pre>
                </div>
                <div id="validationResult" class="min-h-[50px] flex-shrink-0"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let codeEditorInstance; 
document.addEventListener('DOMContentLoaded', () => {
    codeEditorInstance = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
        lineNumbers: true,
        mode: 'python',
        theme: 'material-darker',
        indentUnit: 4,
        autofocus: true
    });
    document.getElementById('runCodeBtn').addEventListener('click', async () => {
        const code = codeEditorInstance.getValue();
        const outputDiv = document.getElementById('codeOutput');
        const validationDiv = document.getElementById('validationResult');
        const runBtn = document.getElementById('runCodeBtn');

        outputDiv.textContent = 'Executing...';
        validationDiv.innerHTML = '';
        runBtn.disabled = true;
        runBtn.classList.add('opacity-50', 'cursor-not-allowed');

        try {
            const response = await fetch('/api/code/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code, lesson_id: '{{ lesson.id }}' })
            });
            const result = await response.json();

            outputDiv.textContent = result.output || 'No output produced.';
            
            const alertClass = result.success ? 'bg-green-500/20 text-green-300' : 'bg-yellow-500/20 text-yellow-300';
            const icon = result.success ? '<i class="fas fa-check-circle mr-3"></i>' : '<i class="fas fa-exclamation-triangle mr-3"></i>';
            validationDiv.innerHTML = `<div class="p-4 rounded-md text-sm flex items-center ${alertClass}">${icon}<span>${result.message}</span></div>`;

        } catch (error) {
            outputDiv.textContent = 'An error occurred while running the code.';
            validationDiv.innerHTML = `<div class="p-4 rounded-md text-sm flex items-center bg-red-500/20 text-red-300"><i class="fas fa-times-circle mr-3"></i><span>Error: ${error}</span></div>`;
        } finally {
            runBtn.disabled = false;
            runBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    });
});

function getPageContext() {
    const instructionsElement = document.getElementById('lesson-instructions');
    const instructions = instructionsElement ? instructionsElement.innerText : 'Instructions not found.';

    const code = codeEditorInstance ? codeEditorInstance.getValue() : 'Code not found.';

    const outputElement = document.getElementById('codeOutput');
    const output = outputElement ? outputElement.textContent : 'Code has not been run yet.';

    return `
### Lesson Instructions
${instructions}

### User's Code
\`\`\`python
${code}
\`\`\`

### Last Output
\`\`\`
${output}
\`\`\`
    `;
}
</script>
{% endblock %}