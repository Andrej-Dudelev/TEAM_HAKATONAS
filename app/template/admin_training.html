{% extends "base.html" %}
{% block title %}Manage Trainings{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 h-full">
    <div class="lg:col-span-1 bg-gray-800/50 rounded-xl p-6 flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-white">Courses</h2>
            <button id="newCourseTrigger" class="inline-flex items-center justify-center px-3 py-1.5 text-sm font-semibold rounded-md shadow-sm transition-transform transform hover:scale-[1.03] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 bg-primary-600 text-white hover:bg-primary-500 focus:ring-primary-500">
                <i class="fas fa-plus mr-2"></i>New Course
            </button>
        </div>
        <div class="flex-grow overflow-y-auto -mr-3 pr-3 space-y-2">
            {% for course in courses %}
            <a href="?course_id={{ course.id }}" class="block p-4 rounded-lg transition-colors {% if request.query_params.get('course_id') == course.id %}bg-primary-600 text-white shadow-lg{% else %}bg-gray-800 hover:bg-gray-700{% endif %}">
                <h3 class="font-semibold">{{ course.title }}</h3>
                <p class="text-sm text-gray-400 mt-1 line-clamp-2">{{ course.description }}</p>
            </a>
            {% else %}
            <div class="text-center text-gray-500 py-10">No courses created yet.</div>
            {% endfor %}
        </div>
    </div>

    <div class="lg:col-span-2">
        {% if selected_course %}
        <div class="bg-gray-800/50 rounded-xl p-6 h-full flex flex-col">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-white">{{ selected_course.title }}</h2>
                    <p class="text-gray-400 mt-1">{{ selected_course.description }}</p>
                </div>
                <div class="flex items-center gap-2">
                    <button class="new-section-trigger inline-flex items-center justify-center px-3 py-1.5 text-sm font-semibold rounded-md shadow-sm transition-transform transform hover:scale-[1.03] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 bg-gray-600 text-white hover:bg-gray-500 focus:ring-gray-500" data-course-id="{{ selected_course.id }}">
                        <i class="fas fa-plus mr-2"></i>New Section
                    </button>
                    <span class="font-mono text-sm bg-primary-500/20 text-primary-300 px-3 py-1 rounded-full">{{ selected_course.compiler }}</span>
                </div>
            </div>
            
            <div class="flex-grow overflow-y-auto space-y-4">
                 {% for section in selected_course.sections %}
                <div class="bg-gray-800 rounded-lg p-4">
                    <h4 class="font-semibold text-white mb-3">{{ section.title }}</h4>
                    <ul class="space-y-2">
                        {% for lesson in section.lessons %}
                        <li class="flex items-center justify-between bg-gray-900/50 p-3 rounded-md">
                            <span class="text-gray-300">{{ lesson.title }}</span>
                           <a href="/admin/training/lesson/{{ lesson.id }}" class="inline-flex items-center justify-center px-3 py-1 text-sm font-semibold rounded-md shadow-sm transition-transform transform hover:scale-[1.03] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 bg-gray-600 text-white hover:bg-gray-500 focus:ring-gray-500">Edit</a>
                        </li>
                        {% else %}
                        <li class="text-gray-500 text-sm p-3"><em>No lessons in this section.</em></li>
                        {% endfor %}
                    </ul>
                    <div class="mt-4 flex items-center gap-2">
                         <a href="/admin/training/section/{{ section.id }}/new-lesson" class="inline-flex items-center justify-center px-3 py-1.5 text-sm font-semibold rounded-md shadow-sm transition-transform transform hover:scale-[1.03] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 bg-gray-600 text-white hover:bg-gray-500 focus:ring-gray-500">
                            <i class="fas fa-plus mr-2"></i>Add Lesson
                         </a>
                         <button class="upload-lessons-trigger inline-flex items-center justify-center px-3 py-1.5 text-sm font-semibold rounded-md shadow-sm transition-transform transform hover:scale-[1.03] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 bg-gray-600 text-white hover:bg-gray-500 focus:ring-gray-500" data-section-id="{{ section.id }}" data-section-title="{{ section.title }}">
                            <i class="fas fa-upload mr-2"></i>Upload Lessons
                         </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="flex items-center justify-center h-full bg-gray-800/50 rounded-xl">
            <div class="text-center">
                <i class="fas fa-folder-open text-5xl text-gray-700"></i>
                <p class="text-gray-500 mt-4">Select a course to manage its content, or create a new one.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block modals %}
<div id="createCourseModal" class="modal-container">
    <div class="modal-content max-w-lg p-6">
        <h3 class="text-xl font-bold mb-4 text-white">Create New Course</h3>
        <form id="createCourseForm" class="space-y-4">
            <div>
                <label for="courseTitle" class="block text-sm font-medium text-gray-300 mb-1">Title</label>
                <input type="text" id="courseTitle" class="appearance-none w-full px-4 py-2 bg-gray-700/50 border border-gray-600 rounded-lg shadow-sm text-gray-200 placeholder-gray-500 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" required placeholder="e.g., Introduction to Python">
            </div>
            <div>
                <label for="courseDescription" class="block text-sm font-medium text-gray-300 mb-1">Description</label>
                <textarea id="courseDescription" class="appearance-none w-full px-4 py-2 bg-gray-700/50 border border-gray-600 rounded-lg shadow-sm text-gray-200 placeholder-gray-500 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" rows="3" placeholder="A brief summary of the course content"></textarea>
            </div>
            <div>
                <label for="courseCompiler" class="block text-sm font-medium text-gray-300 mb-1">Compiler</label>
                <select id="courseCompiler" class="appearance-none w-full px-4 py-2 bg-gray-700/50 border border-gray-600 rounded-lg shadow-sm text-gray-200 placeholder-gray-500 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" style="background-image: url(&quot;data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e&quot;); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem;">
                    <option value="python">Python</option>
                </select>
            </div>
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" class="modal-close inline-flex items-center justify-center px-4 py-2 font-semibold rounded-md shadow-sm transition-transform transform hover:scale-[1.03] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 bg-gray-600 text-white hover:bg-gray-500 focus:ring-gray-500">Cancel</button>
                <button type="button" class="inline-flex items-center justify-center px-4 py-2 font-semibold rounded-md shadow-sm transition-transform transform hover:scale-[1.03] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 bg-primary-600 text-white hover:bg-primary-500 focus:ring-primary-500" id="saveCourseBtn">Save Course</button>
            </div>
        </form>
    </div>
</div>

<div id="createSectionModal" class="modal-container">
    <div class="modal-content max-w-md p-6">
        <h3 class="text-xl font-bold mb-4 text-white">Create New Section</h3>
        <form id="createSectionForm" class="space-y-4">
             <input type="hidden" id="sectionCourseId" value="">
            <div>
                <label for="sectionTitle" class="block text-sm font-medium text-gray-300 mb-1">Section Title</label>
                <input type="text" id="sectionTitle" class="appearance-none w-full px-4 py-2 bg-gray-700/50 border border-gray-600 rounded-lg shadow-sm text-gray-200 placeholder-gray-500 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" required placeholder="e.g., Variables and Data Types">
            </div>
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" class="modal-close inline-flex items-center justify-center px-4 py-2 font-semibold rounded-md shadow-sm transition-transform transform hover:scale-[1.03] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 bg-gray-600 text-white hover:bg-gray-500 focus:ring-gray-500">Cancel</button>
                <button type="button" class="inline-flex items-center justify-center px-4 py-2 font-semibold rounded-md shadow-sm transition-transform transform hover:scale-[1.03] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 bg-primary-600 text-white hover:bg-primary-500 focus:ring-primary-500" id="saveSectionBtn">Save Section</button>
            </div>
        </form>
    </div>
</div>

<div id="uploadLessonsModal" class="modal-container">
    <div class="modal-content max-w-lg p-6">
        <h3 class="text-xl font-bold mb-2 text-white">Upload Lessons</h3>
        <p class="text-gray-400 mb-4">For section: <strong id="uploadSectionTitle"></strong></p>
        <form id="uploadLessonsForm">
            <input type="hidden" id="uploadSectionId" value="">
            <div>
                <label for="lessonFile" class="block text-sm font-medium text-gray-300 mb-1">Select File (.xlsx, .csv)</label>
                <input type="file" id="lessonFile" name="file" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-600 file:text-white hover:file:bg-primary-500 cursor-pointer" required>
                <p class="text-xs text-gray-500 mt-1">File must have 'title' and 'content' columns.</p>
            </div>
            <div id="uploadLessonsStatus" class="mt-3"></div>
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" class="modal-close inline-flex items-center justify-center px-4 py-2 font-semibold rounded-md shadow-sm transition-transform transform hover:scale-[1.03] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 bg-gray-600 text-white hover:bg-gray-500 focus:ring-gray-500">Cancel</button>
                <button type="submit" class="inline-flex items-center justify-center px-4 py-2 font-semibold rounded-md shadow-sm transition-transform transform hover:scale-[1.03] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 bg-primary-600 text-white hover:bg-primary-500 focus:ring-primary-500">Upload and Create</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    setupModal('newCourseTrigger', 'createCourseModal');
    document.getElementById('saveCourseBtn').addEventListener('click', async () => {
        const payload = {
            title: document.getElementById('courseTitle').value,
            description: document.getElementById('courseDescription').value,
            compiler: document.getElementById('courseCompiler').value,
        };
        if (!payload.title) { alert('Title is required.'); return; }
        const response = await fetch('/api/admin/training/courses', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (response.ok) { window.location.reload(); } 
        else { alert('Failed to create course.'); }
    });

    const sectionTrigger = document.querySelector('.new-section-trigger');
    if (sectionTrigger) {
        sectionTrigger.addEventListener('click', (e) => {
            const courseId = e.currentTarget.dataset.courseId;
            document.getElementById('sectionCourseId').value = courseId;
            const modalControls = setupModal(null, 'createSectionModal');
            modalControls.open();
        });
    }

    document.getElementById('saveSectionBtn').addEventListener('click', async () => {
        const payload = {
            course_id: document.getElementById('sectionCourseId').value,
            title: document.getElementById('sectionTitle').value,
        };
        if (!payload.title) { alert('Title is required.'); return; }
        const response = await fetch('/api/admin/training/sections', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (response.ok) { window.location.reload(); } 
        else { alert('Failed to create section.'); }
    });

    const uploadLessonsModal = setupModal(null, 'uploadLessonsModal');
    document.querySelectorAll('.upload-lessons-trigger').forEach(button => {
        button.addEventListener('click', (e) => {
            const sectionId = e.currentTarget.dataset.sectionId;
            const sectionTitle = e.currentTarget.dataset.sectionTitle;
            document.getElementById('uploadSectionId').value = sectionId;
            document.getElementById('uploadSectionTitle').textContent = sectionTitle;
            uploadLessonsModal.open();
        });
    });

    const uploadLessonsForm = document.getElementById('uploadLessonsForm');
    uploadLessonsForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const sectionId = document.getElementById('uploadSectionId').value;
        const fileInput = document.getElementById('lessonFile');
        const statusDiv = document.getElementById('uploadLessonsStatus');
        const submitBtn = uploadLessonsForm.querySelector('button[type="submit"]');

        if (fileInput.files.length === 0) {
            statusDiv.innerHTML = `<p class="text-yellow-400 text-sm">Please select a file.</p>`;
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        statusDiv.innerHTML = `<p class="text-blue-400 text-sm">Uploading and processing...</p>`;
        submitBtn.disabled = true;

        try {
            const response = await fetch(`/api/admin/training/sections/${sectionId}/upload-lessons`, {
                method: 'POST',
                body: formData,
            });
            const result = await response.json();
            if (response.ok) {
                statusDiv.innerHTML = `<p class="text-green-400 text-sm">${result.message}</p>`;
                setTimeout(() => window.location.reload(), 1500);
            } else {
                statusDiv.innerHTML = `<p class="text-red-400 text-sm">Error: ${result.detail}</p>`;
                submitBtn.disabled = false;
            }
        } catch (error) {
            statusDiv.innerHTML = `<p class="text-red-400 text-sm">A network error occurred.</p>`;
            submitBtn.disabled = false;
        }
    });
});
</script>
{% endblock %}