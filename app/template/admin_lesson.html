{% extends "base.html" %}
{% block title %}Edit Lesson{% endblock %}
{% block content %}
<div class="h-full flex flex-col">
    <div class="mb-6 flex-shrink-0">
        <a href="/admin/training?course_id={{ lesson.section.course_id }}" class="text-sm text-primary-400 hover:underline"><i class="fas fa-arrow-left mr-2"></i>Back to Course</a>
        <h1 class="text-3xl font-bold text-white mt-3">Edit Lesson</h1>
        <p class="text-gray-400">Lesson: <span class="font-semibold">{{ lesson.title }}</span></p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-grow min-h-0">
        <!-- Lesson Details -->
        <div class="bg-gray-800/50 rounded-xl p-6 flex flex-col gap-4">
            <h2 class="text-xl font-semibold text-white">Lesson Details</h2>
            <div>
                <label for="lessonTitle" class="label">Lesson Title</label>
                <input type="text" id="lessonTitle" class="appearance-none w-full px-4 py-2 bg-gray-700/50 border border-gray-600 rounded-lg shadow-sm text-gray-200 placeholder-gray-500 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" value="{{ lesson.title }}" required>
            </div>
            <div class="editor-container">
                 <label for="lessonContent" class="label">Instructions (Content)</label>
                 <textarea id="lessonContent">{{ lesson.content }}</textarea>
            </div>
             <div>
                <label for="lessonOrder" class="label">Order</label>
                <input type="number" id="lessonOrder" class="appearance-none w-24 px-4 py-2 bg-gray-700/50 border border-gray-600 rounded-lg shadow-sm text-gray-200 placeholder-gray-500 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" value="{{ lesson.order }}">
            </div>
        </div>

        <!-- Code & Validation Panel -->
        <div class="bg-gray-800/50 rounded-xl flex flex-col min-h-0">
            <div class="p-6 flex flex-col gap-4 flex-grow">
                <h2 class="text-xl font-semibold text-white">Code & Validation</h2>
                <div class="editor-container">
                    <label for="startingCode" class="label">Starter Code</label>
                    <textarea id="startingCode">{{ lesson.starting_code or '' }}</textarea>
                </div>
                <div class="border-t border-gray-700 pt-4">
                     <h3 class="text-lg font-semibold text-white mb-2">Validation Criteria</h3>
                     <div class="space-y-3">
                        <div>
                            <label for="validationType" class="label">Validation Type</label>
                            <select id="validationType" class="appearance-none w-full px-4 py-2 bg-gray-700/50 border border-gray-600 rounded-lg shadow-sm text-gray-200 placeholder-gray-500 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" style="background-image: url(&quot;data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e&quot;); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem;">
                                <option value="none">None</option>
                                <option value="exact_match">Exact Match</option>
                                <option value="contains">Contains</option>
                                <option value="function_call">Function Call</option>
                            </select>
                        </div>
                        <div id="validation-fields">
                            <!-- Fields will be dynamically inserted here by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="mt-6 flex-shrink-0 flex justify-end">
        <button id="saveLessonBtn" class="btn btn-primary btn-lg"><i class="fas fa-save mr-2"></i>Save Changes</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% include 'admin_lesson_script.js' %}
<script>
const lessonData = {{ lesson.json() | safe }};

document.addEventListener('DOMContentLoaded', () => {
    // Populate validation fields from existing lesson data
    populateValidationFields(lessonData.validation_criteria);

    const saveButton = document.getElementById('saveLessonBtn');
    saveButton.addEventListener('click', async () => {
        const payload = {
            title: document.getElementById('lessonTitle').value,
            content: document.getElementById('lessonContent').value,
            starting_code: document.getElementById('startingCode').value,
            order: parseInt(document.getElementById('lessonOrder').value, 10),
            validation_criteria: buildValidationCriteria()
        };
        
        if (!payload.title || !payload.content) {
            alert('Title and Content are required.');
            return;
        }

        const response = await fetch(`/api/admin/training/lessons/{{ lesson.id }}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            // Add visual feedback
            saveButton.classList.remove('btn-primary');
            saveButton.classList.add('btn-success');
            saveButton.innerHTML = '<i class="fas fa-check mr-2"></i>Saved!';
            setTimeout(() => {
                 saveButton.classList.remove('btn-success');
                 saveButton.classList.add('btn-primary');
                 saveButton.innerHTML = '<i class="fas fa-save mr-2"></i>Save Changes';
            }, 2000);
        } else {
            const error = await response.json();
            alert('Failed to save lesson: ' + (error.detail || 'Unknown error'));
        }
    });
});
</script>
{% endblock %}

